<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystery Mansion - Lockout</title>
    <style>
        :root {
            --red: #ff0000;
            --dark-red: #4d0000;
            --font-color: #f0f0f0;
            --text-color: #c0c0c0;
            --bg-color: #1a1a1a;
            --green: #00ff00;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', Courier, monospace;
            color: var(--font-color);
            background-color: var(--bg-color);
            height: auto;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            text-align: center;
            box-sizing: border-box;
            background: radial-gradient(circle, var(--red) 0%, var(--dark-red) 70%, var(--bg-color) 100%);
            transition: all 0.5s ease-in-out;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .container.banner {
            height: 15vh;
            justify-content: center;
            background: radial-gradient(circle, var(--red) 0%, var(--dark-red) 100%);
            border-bottom: 2px solid var(--red);
            position: fixed;
        }

        /* New CSS class for the win banner */
        .container.win-banner {
            height: 15vh;
            justify-content: center;
            background: rgb(17, 24, 39);
            border-bottom: 2px solid rgb(31, 41, 55);
            position: fixed;
        }

        .system-locked-img {
            max-width: 90%;
            width: auto;
            max-height: 80vh;
            height: auto;
            filter: drop-shadow(0 0 10px var(--red));
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1; /* Initial state */
        }
        
        .container.banner .system-locked-img {
            max-height: none;
            height: 100%;
        }

        .system-locked-img.hidden {
            opacity: 0;
        }

        .system-locked-img.fade-in {
            opacity: 1;
        }

        .begin-link {
            position: absolute;
            bottom: 5vh;
            text-decoration: none;
            color: var(--font-color);
            font-size: 2em;
            cursor: pointer;
            text-shadow: 0 0 5px var(--red);
            transition: transform 0.2s ease-in-out;
        }

        .begin-link:hover {
            transform: scale(1.1);
        }

        .ransom-container {
            width: 100%;
            min-height: 100vh;
            padding: calc(15vh + 2em) 2em 2em;
            box-sizing: border-box;
            display: none;
            flex-direction: column;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            z-index: 1;
            position: relative;
        }

        .ransom-container.active {
            display: flex;
        }
        
        .ransom-demands {
            width: 100%;
            max-width: 800px;
            text-align: left;
            margin-bottom: 2em;
        }
        
        .ransom-demands h2 {
            color: var(--red);
            font-size: 2em;
            text-shadow: 0 0 5px var(--red);
        }

        .ransom-demands p {
            line-height: 1.5;
            font-size: 1.1em;
        }

        #passphrase-input-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1em;
        }
        
        #passphrase-input-container.flash-red #passphrase-input {
            animation: flashRed 0.6s 3;
        }

        #passphrase-input-container.flash-green #passphrase-input {
            animation: flashGreen 0.6s 3;
        }

        #passphrase-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background-color: var(--bg-color);
            border: 2px solid var(--dark-red);
            color: var(--font-color);
            text-align: center;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s;
            outline: none;
        }
        
        #passphrase-input:focus {
            box-shadow: 0 0 15px var(--red);
        }
        
        #passphrase-input::placeholder {
            color: #555;
        }
        
        @keyframes flashRed {
            0%, 50%, 100% { border-color: var(--dark-red); box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            25%, 75% { border-color: var(--red); box-shadow: 0 0 20px var(--red); }
        }

        @keyframes flashGreen {
            0%, 50%, 100% { border-color: var(--dark-red); box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            25%, 75% { border-color: var(--green); box-shadow: 0 0 20px var(--green); }
        }

        #attempts-counter {
            color: var(--red);
            font-size: 1.2em;
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            transition: color 0.3s, text-shadow 0.3s, visibility 0s 0.6s;
        }
        
        #attempts-counter.hidden {
            visibility: hidden;
            transition: visibility 0s;
        }

        .forgot-passphrase-link {
            margin-top: 1em;
            color: var(--red);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .forgot-passphrase-link:hover {
            color: var(--font-color);
        }

        .clue-section {
            width: 100%;
            max-width: 800px;
            margin-top: 2em;
            display: none;
            flex-direction: column;
            gap: 1em;
            overflow: hidden;
            text-align: left;
            padding: 0 1em;
            box-sizing: border-box;
        }

        .clue-section.active {
            display: flex;
        }

        .clue-section p {
            font-size: 1em;
            color: var(--text-color);
            margin: 0;
            text-align: center;
        }
        
        .clue-boxes {
            display: flex;
            flex-direction: column;
            gap: 1em;
            margin-top: 1em;
        }
        
        .clue-row {
            display: flex;
            justify-content: center;
            gap: 1em;
        }
        
        @media (max-width: 768px) {
            .clue-row {
                flex-direction: column;
            }
        }

        .clue-box-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5em;
            padding: 0 0.5em;
        }

        .clue-input {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            background-color: var(--bg-color);
            border: 2px solid var(--dark-red);
            color: var(--font-color);
            text-align: center;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .clue-input.correct {
            border-color: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }
        
        .clue-input.incorrect {
            border-color: var(--red);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .revealed-clue {
            color: var(--font-color);
            text-align: center;
            font-size: 1em;
            margin-top: 0.5em;
            min-height: 1.5em;
            background-color: #222;
            padding: 5px;
            border-radius: 5px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            width: 100%;
            word-wrap: break-word;
        }
        
        .revealed-clue.active {
            visibility: visible;
            opacity: 1;
        }

        .final-screen {
            position: fixed;
            top: 15vh; /* This positions the screen below the banner */
            left: 0;
            width: 100vw;
            height: 85vh; /* This adjusts the height to fill the remaining space */
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            /* Updated background color */
            background-color: rgb(17, 24, 39); 
            z-index: 200;
        }

        .final-screen.active {
            display: flex;
        }

        .final-screen h2 {
            font-size: 4em;
            margin-bottom: 0.5em;
        }
        
        .final-screen.win h2 {
            color: #00ff00;
            text-shadow: 0 0 15px #00ff00;
        }
        
        .final-screen.fail h2 {
            color: var(--red);
            text-shadow: 0 0 15px var(--red);
        }

        .final-screen p {
            font-size: 1.5em;
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <div id="introScreen" class="container">
        <img id="systemLockedImg" class="system-locked-img" src="systemlocked.png" alt="System Locked">
        <a href="#" id="beginLink" class="begin-link">click to begin</a>
    </div>
    
    <div id="ransomScreen" class="ransom-container">
        <div class="ransom-demands">
            <h2>Access Denied!</h2>
            <p>You've triggered the system's security protocol. All data is now encrypted and on a timer. To regain control, you must provide the correct passphrase.</p>
            <p>The passphrase is known only by a select few. You have one chance to enter it correctly. Incorrect entry will result in permanent data deletion.</p>
            <p>Your team has gathered clues. Unscramble the phrases and piece together the final passphrase to save the data.</p>
        </div>
        <div id="passphrase-input-container">
            <div id="attempts-counter">Attempts remaining: 3</div>
            <input type="text" id="passphrase-input" placeholder="Enter passphrase and press enter...">
        </div>
        <a href="#" id="forgotPassphraseLink" class="forgot-passphrase-link">Forgot passphrase?</a>
        <div id="clueSection" class="clue-section">
            <p>Input the 8 security codes from the sensors below to reveal parts of the unlock phrase.</p>
            <div id="clueBoxes" class="clue-boxes">
                <div class="clue-row">
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                </div>
                <div class="clue-row">
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                    <div class="clue-box-container">
                        <input type="text" class="clue-input" placeholder="Code">
                        <div class="revealed-clue"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="winScreen" class="final-screen win">
        <h2>System Unlocked!</h2>
        <p>Thank you for playing Mystery Mansion - Lockout</p>
    </div>

    <div id="failScreen" class="final-screen fail">
        <h2>You Failed!</h2>
        <p>Thank you for playing Mystery Mansion - Lockout</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const beginLink = document.getElementById('beginLink');
            const introScreen = document.getElementById('introScreen');
            const systemLockedImg = document.getElementById('systemLockedImg');
            const ransomScreen = document.getElementById('ransomScreen');
            const forgotPassphraseLink = document.getElementById('forgotPassphraseLink');
            const clueSection = document.getElementById('clueSection');
            const passphraseInputContainer = document.getElementById('passphrase-input-container');
            const passphraseInput = document.getElementById('passphrase-input');
            const attemptsCounter = document.getElementById('attempts-counter');
            const winScreen = document.getElementById('winScreen');
            const failScreen = document.getElementById('failScreen');
            const clueBoxes = document.getElementById('clueBoxes');

            // The fixed codes that the player must enter
            const fixedCodes = ["JOHN", "MARK", "LUKE", "MARY", "1411", "1234", "0832", "6741"];

            // List of potential unlock phrases
            const allPhrases = [
                "And they were glad when they heard it, and promised to give him money. Mark 14:11",
                "For where your treasure is, there your heart will be also. Luke 12:34",
                "Then you will know the truth, and the truth will set you free. John 08:32"
            ];

            let correctPassphrase = "";
            let shuffledClueMappings = [];
            let usedCodes = new Set();
            let attemptsRemaining = 3;

            // Select a random phrase on load
            const randomIndex = Math.floor(Math.random() * allPhrases.length);
            const selectedPhrase = allPhrases[randomIndex];
            correctPassphrase = selectedPhrase.toLowerCase();

            // Split the selected phrase into sections for the clues
            const phraseParts = selectedPhrase.split(' ');
            const numClues = fixedCodes.length;
            const clues = [];

            // A robust way to chunk the phrase into 8 clues
            const totalWords = phraseParts.length;
            const wordsPerClue = Math.floor(totalWords / numClues);
            let remainder = totalWords % numClues;
            let currentWordIndex = 0;

            for (let i = 0; i < numClues; i++) {
                let currentClue = '';
                let wordsToTake = wordsPerClue;
                if (remainder > 0) {
                    wordsToTake++;
                    remainder--;
                }
                for (let j = 0; j < wordsToTake; j++) {
                    if (currentWordIndex < totalWords) {
                        currentClue += phraseParts[currentWordIndex] + ' ';
                        currentWordIndex++;
                    }
                    if (currentWordIndex >= totalWords) break;
                }
                clues.push(currentClue.trim());
            }

            const clueMappings = fixedCodes.map((code, index) => ({
                code: code.toLowerCase(),
                clue: clues[index]
            }));

            // Shuffle the mappings so that each code reveals a random clue
            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            shuffledClueMappings = shuffleArray(clueMappings);

            // Get all clue box containers and randomize their order
            const allClueContainers = Array.from(document.querySelectorAll('.clue-box-container'));
            const shuffledContainers = shuffleArray(allClueContainers);
            
            // Get the parent element to re-append the shuffled containers to
            const parentRow = clueBoxes.querySelector('.clue-row');

            // Clear the existing clue boxes
            parentRow.innerHTML = '';
            
            // Re-append the shuffled containers to the DOM
            shuffledContainers.forEach(container => {
                parentRow.appendChild(container);
            });

            beginLink.addEventListener('click', (e) => {
                e.preventDefault();
                beginLink.style.display = 'none';

                // Add the banner class to start the container resize
                introScreen.classList.add('banner');

                // Fade out the current image
                systemLockedImg.classList.add('hidden');

                // Listen for the fade-out transition to complete
                const handleTransitionEnd = () => {
                    // Replace the image source
                    systemLockedImg.src = 'systemlockedsm.png';
                    
                    // Remove the hidden class and add the fade-in class
                    systemLockedImg.classList.remove('hidden');
                    systemLockedImg.classList.add('fade-in');

                    // Activate the ransom screen
                    ransomScreen.classList.add('active');

                    // Remove the event listener to prevent it from firing again
                    systemLockedImg.removeEventListener('transitionend', handleTransitionEnd);
                };

                systemLockedImg.addEventListener('transitionend', handleTransitionEnd);
            });

            forgotPassphraseLink.addEventListener('click', (e) => {
                e.preventDefault();
                clueSection.classList.toggle('active');
            });
            
            // Function to normalize a string for comparison (lowercase, no spaces or punctuation)
            const normalizeString = (str) => {
                return str.replace(/[.,\/#!$%\^&"'\*;:{}=\-_`~()]/g, "").replace(/\s/g, "").toLowerCase();
            };

            passphraseInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Normalize both the user's input and the correct passphrase before comparison
                    if (normalizeString(passphraseInput.value) === normalizeString(correctPassphrase)) {
                        passphraseInputContainer.classList.add('flash-green');
                        setTimeout(() => {
                            // Remove the old banner and add the new one
                            introScreen.classList.remove('banner');
                            introScreen.classList.add('win-banner');
                            
                            // Update the image
                            systemLockedImg.src = 'apostlesecurity.png';
                            systemLockedImg.style.maxHeight = '100%';
                            systemLockedImg.style.filter = 'none';
                            
                            ransomScreen.style.display = 'none';
                            winScreen.classList.add('active');
                            setTimeout(() => {
                                window.location.reload();
                            }, 30000);
                        }, 600);
                    } else {
                        attemptsRemaining--;
                        attemptsCounter.classList.add('hidden');
                        passphraseInputContainer.classList.add('flash-red');
                        
                        setTimeout(() => {
                            attemptsCounter.textContent = `Attempts remaining: ${attemptsRemaining}`;
                            attemptsCounter.classList.remove('hidden');
                            passphraseInputContainer.classList.remove('flash-red');
                            passphraseInput.value = '';
                            if (attemptsRemaining <= 0) {
                                // We keep the introScreen (banner) but hide the ransom screen
                                ransomScreen.style.display = 'none';
                                failScreen.classList.add('active');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 30000);
                            }
                        }, 600);
                    }
                }
            });

            const clueInputs = document.querySelectorAll('.clue-input');

            clueInputs.forEach((input) => {
                const revealedClueDiv = input.nextElementSibling;
                
                const checkCode = () => {
                    const enteredCode = input.value.trim().toLowerCase();

                    if (usedCodes.has(enteredCode)) {
                        input.classList.add('incorrect');
                        setTimeout(() => {
                            input.classList.remove('incorrect');
                            input.value = '';
                        }, 500);
                        return;
                    }

                    const foundClue = shuffledClueMappings.find(mapping => mapping.code === enteredCode);

                    if (foundClue) {
                        input.classList.add('correct');
                        input.disabled = true;
                        revealedClueDiv.textContent = foundClue.clue;
                        revealedClueDiv.classList.add('active');
                        input.value = foundClue.code.toUpperCase();
                        usedCodes.add(enteredCode);
                    } else {
                        input.classList.add('incorrect');
                        setTimeout(() => {
                            input.classList.remove('incorrect');
                            input.value = '';
                        }, 500);
                    }
                };

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkCode();
                    }
                });

                input.addEventListener('blur', checkCode);
            });
        });
    </script>
</body>
</html>
